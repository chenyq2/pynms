<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>XPATH and Data Tree Structure</title> <meta name="description" content=" Overview PyangBind’s XPathHelper Classes Usage of YANGPathHelper"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="http://pynms.io/xpath"> <link rel="alternate" type="application/rss+xml" title="PyNMS" href="http://pynms.io/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="primary-nav"> <li><a href="/">Home</a></li> <li><a href="/about">About</a></li> <li><a href="/docs">Documentation Notes</a></li> <li><a href="/pyangbind">PyangBind Documentation</a></li> <li><a href="https://github.com/robshakir/pynms" target="_blank"><i class="icon icon-github"></i> GitHub</a></li> <!--<li><a href="http://twitter.com/robshakir" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li>--> <!-- <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> RSS</a></li>--> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div> <h1 class="post-title" itemprop="name headline"><span class="controlled-title">PyangBind: XPATH and Data Tree Structure</span></h1> </div> <div class="zone"> <span class="naviitem"><a class="naviitem" href="/pyangbind/">Overview</a></span> <span class="naviitem"><a class="naviitem" href="/pyangbind/getting_started">Getting Started</a></span> <span class="naviitem"><a class="naviitem" href="/pyangbind/usage">Usage</a></span> <span class="naviitem"><a class="naviitem" href="/pyangbind/generic_methods">Generic Methods</a></span> <span class="naviitem"><a class="naviitem" href="/errors">Errors</a></span> <span class="naviitem"><a class="naviitem" href="/serialisation">Serialisation</a></span> <span class="naviitem"><a class="naviitem" href="/xpath">XPATH</a></span> <span class="naviitem"><a class="naviitem" href="/extmethods">Extension Methods</a></span> <span class="naviitem"><a class="naviitem" href="/rpc">RPCs</a></span> <span class="naviitem"><a class="naviitem" href="/yang">YANG Mapping</a></span> </div> </header> <div class="post-content container" itemprop="articleBody"> <ul> <li><a href="#overview">Overview</a></li> <li><a href="#xpathhelpercls">PyangBind’s XPathHelper Classes</a></li> <li><a href="#yangpathhelper">Usage of YANGPathHelper</a></li> </ul> <hr /> <h2 id="overview-a-nameoverviewa">Overview <a name="overview"></a></h2> <p>YANG data models describe a tree structure - where there is a single root for all modules, and each module creates schema nodes (e.g., containers or leaves) at that root. Essentially (based on YANG’s historical ties to XML) this tree structure is conceptually an XML document - and hence XPATH expressions are used to provide references between different elements in the tree.</p> <p>For example:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>leaf reference {
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>  type leafref {
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>    path &quot;/path/to/another/node&quot;;
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>  }
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>}
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>augment &quot;/bgp&quot; {
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  uses some-new-grouping;
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>}
</pre></div> </div> </div> <p>Both the augment and leafref statements here utilise XPATH expressions to refer to a remote node. When the value of a leafref is set then there is a requirement to check the value it is set to against the path that it refers to.</p> <hr /> <h2 id="pyangbinds-xpathhelper-classes-a-namexpathhelperclsa">PyangBind’s XPathHelper Classes <a name="xpathhelpercls"></a></h2> <p>To allow such references to be looked up, all PyangBind classes take an argument of <code>path_helper</code> which points to an object that they can use to resolve an XPATH expression into the data instances that that path refers to.</p> <p>Generically, this helper class is described in <code>pyangbind.lib.xpathhelper</code> as the <code>PyangbindXpathHelper</code> class. This is a skeleton class (or interface, essentially) - that specifies the methods that PyangBind classes expect of this helper module. These are:</p> <ul> <li><code>register(self, path, object_ptr, caller=False)</code> - this method is called when a PyangBind object is created such that a pointer between the <code>path</code> argument and the object referred to by <code>object_ptr</code> can be maintained by the XPathHelper class. The <code>caller</code> argument specifies the path to the object that is making the <code>register()</code> call - with the logic that the <code>path</code> argument may be relative in some cases.</li> <li><code>unregister(self, path, caller=False)</code> - this function is the partner to <code>register()</code> and is called when a PyangBind object is removed to remove the mapping for its path.</li> <li><code>get(self, path, caller=False)</code> - this function is used by PyangBind to retrieve all data nodes that correspond to a certain path.</li> </ul> <p>It is intended that there can be multiple implementations of the XPathHelper interface such that one can use it to provide database backing if required (e.g., the XPathHelper class’ <code>register</code> method could be used to serialise the corresponding data instances and insert them into a database).</p> <hr /> <h2 id="pyangbinds-yangpathhelper-class">PyangBind’s YANGPathHelper Class</h2> <p><code>pyangbind.lib.xpathhelper</code> provides an implementation of an XPathHelper class named <code>YANGPathHelper</code>. This class implements an in-memory mapping between paths and the corresponding PyangBind object. It does this by constructing a lightweight XML document of the form:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#070;font-weight:bold">&lt;root&gt;</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#070;font-weight:bold">&lt;bgp</span> <span style="color:#b48">object_ptr</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">(str)</span><span style="color:#710">'</span></span><span style="color:#070;font-weight:bold">&gt;</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    <span style="color:#070;font-weight:bold">&lt;neighbors</span> <span style="color:#b48">object_ptr</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">(str)</span><span style="color:#710">'</span></span><span style="color:#070;font-weight:bold">&gt;</span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>      <span style="color:#070;font-weight:bold">&lt;neighbor</span> <span style="color:#b48">peer-addr</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">192.0.2.1</span><span style="color:#710">'</span></span> <span style="color:#b48">object_ptr</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">(str)</span><span style="color:#710">'</span></span><span style="color:#070;font-weight:bold">&gt;</span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>        ...
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>      <span style="color:#070;font-weight:bold">&lt;/neighbor&gt;</span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    <span style="color:#070;font-weight:bold">&lt;/neighbors&gt;</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  <span style="color:#070;font-weight:bold">&lt;/bgp&gt;</span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span><span style="color:#070;font-weight:bold">&lt;/root&gt;</span>
</pre></div> </div> </div> <p>The <code>object_ptr</code> attribute of each XML Element provides a reference to an entry in <code>_library</code> dictionary which stores references to the PyangBind classes. The contents of the document can be viewed using the <code>tostring()</code> method of any YANGPathHelper instance.</p> <p>The YANGPathHelper provides a <code>get()</code> and <code>get_unique()</code> method - the latter raises an exception if there is &gt;1 object corresponding to the path that is specified.</p> <hr /> <h2 id="usage-of-yangpathhelper-a-nameyangpathhelpera">Usage of YANGPathHelper <a name="yangpathhelper"></a></h2> <p>To initialise a YANGPathHelper class and use it with PyangBind-generated classes, the bindings must have been specified with the <code>--use-xpathhelper</code> argument. This ensures that the bindings are configured to pass the <code>path_helper</code> reference to one another as new classes are instantiated.</p> <p>In order to then use the YANGPathHelper, an instance should be created and then handed to the PyangBind class as it is created through the <code>path_helper</code> kwarg:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>&gt;&gt;&gt;
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>&gt;&gt;&gt; <span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">openconfig</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">openconfig_bgp</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>&gt;&gt;&gt; <span style="color:#080;font-weight:bold">from</span> <span style="color:#B44;font-weight:bold">pyangbind.lib.xpathhelper</span> <span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">YANGPathHelper</span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>&gt;&gt;&gt;
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>&gt;&gt;&gt; ph = YANGPathHelper()
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>&gt;&gt;&gt; ob = openconfig_bgp(path_helper=ph)
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>&gt;&gt;&gt;
</pre></div> </div> </div> <p>Following this initialisation, the classes are then utilised as per the normal operation:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>&gt;&gt;&gt; peer = ob.bgp.neighbors.neighbor.add(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">192.0.2.1</span><span style="color:#710">&quot;</span></span>)
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>&gt;&gt;&gt; peer.config.peer_as = <span style="color:#00D">15169</span>
</pre></div> </div> </div> <p>After creating an entry such as this, it is then possible to view the data using the standard <code>.get()</code> method, and see the XML document that has been created by the <code>YANGPathHelper</code> <code>ph</code> object:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>&gt;&gt;&gt; <span style="color:#080;font-weight:bold">print</span> peer.get(filter=<span style="color:#069">True</span>)
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>{<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">neighbor-address</span><span style="color:#710">'</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#E40">u</span><span style="color:#710">'</span><span style="color:#D20">192.0.2.1</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">config</span><span style="color:#710">'</span></span>: {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">neighbor-address</span><span style="color:#710">'</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#E40">u</span><span style="color:#710">'</span><span style="color:#D20">192.0.2.1</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">peer-as</span><span style="color:#710">'</span></span>: <span style="color:#00D">15169</span>}}
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>&gt;&gt;&gt; <span style="color:#080;font-weight:bold">print</span> ph.tostring(pretty_print=<span style="color:#069">True</span>)
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>&lt;root&gt;
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>  &lt;bgp obj_ptr=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">cedd3b87-edf1-11e5-92c1-acbc32aad1a5</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>    &lt;neighbors obj_ptr=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">cee14035-edf1-11e5-a7be-acbc32aad1a5</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>      &lt;neighbor obj_ptr=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">d329332b-edf1-11e5-9868-acbc32aad1a5</span><span style="color:#710">&quot;</span></span> neighbor-address=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">192.0.2.1</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>        &lt;route-reflector obj_ptr=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">d3294b63-edf1-11e5-b14d-acbc32aad1a5</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>...
</pre></div> </div> </div> <p>It is rare that there is a requirement to interact directly with this XML. Rather the <code>get()</code> method of the <code>ph</code> object can now be utilised to retrieve values by their path.</p> <p>For instance, if another peer is added (<code>10.0.0.1</code>, <code>config.peer_as = 6643</code>), then the following XPATH expressions retrieve the possible neighbors, and a particular neighbor’s AS number:</p><pre><code>&gt;&gt;&gt; ph.get("/bgp/neighbors/neighbor/neighbor-address")
[u'192.0.2.1', u'10.0.0.1']
&gt;&gt;&gt; ph.get("/bgp/neighbors/neighbor[neighbor-address='192.0.2.1']/config/peer-as")
[15169]
&gt;&gt;&gt; ph.get_unique("/bgp/neighbors/neighbor[neighbor-address='10.0.0.1']/config/peer-as")
6643
</code></pre><p>The <code>get()</code> method will return a list of all objects that match the expression, whereas <code>get_unique</code> will return an individual object.</p> <p>When looking up a certain neighbor, it is possible to utilise the <code>_parent</code> attribute of a particular object to traverse up the tree to retrieve a wider object. For instance:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>&gt;&gt;&gt; peer_as = ph.get_unique(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/bgp/neighbors/neighbor[neighbor-address='10.0.0.1']/config/peer-as</span><span style="color:#710">&quot;</span></span>)
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>&gt;&gt;&gt; peer_as._parent._parent.get(filter=<span style="color:#069">True</span>)
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>{<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">neighbor-address</span><span style="color:#710">'</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#E40">u</span><span style="color:#710">'</span><span style="color:#D20">10.0.0.1</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">config</span><span style="color:#710">'</span></span>: {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">neighbor-address</span><span style="color:#710">'</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#E40">u</span><span style="color:#710">'</span><span style="color:#D20">10.0.0.1</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">peer-as</span><span style="color:#710">'</span></span>: <span style="color:#00D">6643</span>}}
</pre></div> </div> </div> <p>No action is required to ensure that objects unregister themselves as they are removed from the data tree:</p> <div class="highlighter-coderay"><div class="CodeRay"> <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>&gt;&gt;&gt; ob.bgp.neighbors.neighbor.delete(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">10.0.0.1</span><span style="color:#710">&quot;</span></span>)
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>&gt;&gt;&gt; ph.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/bgp/neighbors/neighbor/neighbor-address</span><span style="color:#710">&quot;</span></span>)
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#E40">u</span><span style="color:#710">'</span><span style="color:#D20">192.0.2.1</span><span style="color:#710">'</span></span>]
</pre></div> </div> </div> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="https://github.com/robshakir" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://uk.linkedin.com/in/robjs" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/robshakir" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2016 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html><!-- by nandomoreira.me -->